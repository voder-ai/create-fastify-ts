# 005.0-DEVELOPER-SECURITY-HEADERS: Verify Security Headers Configured

## Release Goal

**Production-Ready Foundation** - Enable developers to get from zero to working API server in under 30 seconds with a single npm init command.

This story validates a critical part of the template's "production-ready" and "secure by default" promise. After the development server starts (003.0), developers need to verify that security headers are properly configured and understand what protections are in place, what headers do, and how to customize them for their specific needs.

## How This Story Contributes

This story provides confidence that the template delivers on its security promise and educates developers about web security. It enables:

- **Security Validation**: Confirms that @fastify/helmet is properly configured with sensible defaults
- **Security Education**: Developer understands what each security header does and why it matters
- **Production Confidence**: Template meets security best practices for production deployments (OWASP guidance)
- **Customization Knowledge**: Developer knows how to adjust headers (especially CSP) for their specific use case
- **CORS Understanding**: Developer knows when and how to enable CORS securely (opt-in with environment-based examples)

## User Story

**Format**: So that I can confidently deploy a secure API and understand the security protections in place, as an API Developer, I want to verify that security headers are configured with sensible defaults and know how to customize them when needed.

**INVEST Criteria Compliance**:

- **Independent**: Depends only on 003.0 (running dev server); can be verified in parallel with other verification stories
- **Negotiable**: Specific headers to verify and documentation depth can be refined based on security requirements
- **Valuable**: Enables confident production deployment - developer knows template is secure by default
- **Estimable**: Clear scope - verify headers present, understand what they do, know how to customize
- **Small**: Single iteration - focused on verification and understanding of existing security configuration
- **Testable**: Clear success criteria - headers present in responses, developer can explain what they do

## Acceptance Criteria

- [x] **Helmet Headers Present**: HTTP responses include security headers from @fastify/helmet (Content-Security-Policy, X-Frame-Options, Strict-Transport-Security, X-Content-Type-Options, etc.)
- [x] **Header Verification Test**: Template includes test that verifies security headers are present in HTTP responses
- [x] **Header Documentation**: Documentation explains what each security header does and what attacks it prevents
- [x] **CSP Customization Guide**: Clear examples showing how to customize Content-Security-Policy for different frontend needs
- [x] **CORS Opt-In Documentation**: Documentation explains when CORS is needed, why it's opt-in, and how to enable it securely
- [x] **Environment-Based CORS Examples**: Examples show development-friendly and production-safe CORS configurations
- [x] **Security Best Practices**: Documentation references OWASP recommendations and explains security trade-offs
- [x] **Quick Reference**: Developer can quickly find which headers are set and access customization examples

The automated verification of these criteria is implemented in `src/generated-project-security-headers.test.ts`, which exercises **REQ-SEC-HEADERS-TEST** by asserting that the expected security headers are present on responses from the `/health` endpoint of a freshly generated project.

## Requirements

- **REQ-SEC-HELMET-DEFAULT**: @fastify/helmet registered with sensible defaults that protect against common vulnerabilities
- **REQ-SEC-HEADERS-PRESENT**: All responses include security headers (CSP, X-Frame-Options, HSTS, X-Content-Type-Options, etc.)
- **REQ-SEC-HEADERS-TEST**: Test suite verifies security headers are present in HTTP responses
- **REQ-SEC-HEADER-DOCS**: Documentation explains purpose of each security header and attacks prevented
- **REQ-SEC-CSP-CUSTOM**: Examples show how to customize CSP for different frontend frameworks (React, Vue, etc.)
- **REQ-SEC-CORS-OPTOUT**: CORS not enabled by default (security by default - no cross-origin access unless explicitly needed)
- **REQ-SEC-CORS-DOCS**: Documentation explains when CORS is needed and provides secure configuration examples
- **REQ-SEC-CORS-ENV**: Examples show environment-based CORS (permissive in dev, restrictive in prod)
- **REQ-SEC-OWASP**: Documentation references OWASP security recommendations and best practices

## Dependencies

- **003.0-DEVELOPER-DEV-SERVER**: Requires running server to verify headers in HTTP responses

## Implementation Notes

**Security Headers Context**:

- Template uses @fastify/helmet (per ADR 0006) which sets 11+ security headers automatically
- Headers protect against: XSS, clickjacking, MIME sniffing, insecure HTTPS, and other OWASP top 10 threats
- Sensible defaults work for most APIs without customization
- CSP may need adjustment for APIs serving frontend assets or using specific CDNs

**CORS Context** (per ADR 0009):

- CORS is opt-in (not enabled by default) to maintain "secure by default" principle
- CORS only needed when API consumed by browser-based frontends on different domains
- Documentation provides environment-based examples (permissive in dev, restrictive in prod)
- Template includes commented-out CORS example and environment variable placeholders

**Headers Set by Helmet**:

1. **Content-Security-Policy**: Prevents XSS by controlling which resources can load
2. **X-DNS-Prefetch-Control**: Controls browser DNS prefetching
3. **Expect-CT**: Certificate Transparency enforcement
4. **X-Frame-Options**: Prevents clickjacking (DENY or SAMEORIGIN)
5. **Strict-Transport-Security**: Forces HTTPS connections (HSTS)
6. **X-Download-Options**: Prevents IE from executing downloads in site context
7. **X-Content-Type-Options**: Prevents MIME sniffing
8. **Origin-Agent-Cluster**: Isolates agent clusters
9. **X-Permitted-Cross-Domain-Policies**: Controls Flash/PDF cross-domain
10. **Referrer-Policy**: Controls referrer information leakage
11. **X-XSS-Protection**: Legacy XSS protection for older browsers

**Developer Education Goals**:

- Developer understands WHY these headers matter (not just that they're present)
- Developer knows WHEN to customize (e.g., CSP for frontend apps)
- Developer knows HOW to customize safely (examples for common scenarios)
- Developer understands CORS security implications (why it's opt-in)

## Definition of Done

- [x] Security headers present in all HTTP responses
- [x] All acceptance criteria met
- [x] Tests verify security headers are configured
- [x] Documentation explains each header's purpose and customization
- [x] CORS opt-in documented with secure examples
- [x] Developer can answer "What security is enabled by default?"
- [x] Story map updated with story reference

---

## Story Metadata

- **Story Number**: 005.0
- **Persona**: Developer (API Developer), with value for Project Lead and DevOps Engineer
- **Theme**: Production-Ready Foundation â†’ Security & Observability
- **Journey Phase**: Verify Setup
- **Estimated Effort**: Low
- **Priority**: 5 (High Cost of Delay - template markets itself as "production-ready" and "secure by default")
