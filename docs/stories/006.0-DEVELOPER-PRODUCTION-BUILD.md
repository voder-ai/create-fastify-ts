# 006.0-DEVELOPER-PRODUCTION-BUILD: Build and Run Production Bundle

## Release Goal

**Production-Ready Foundation** - Enable developers to get from zero to working API server in under 30 seconds with a single npm init command.

This story completes the production readiness verification by ensuring the TypeScript code compiles to optimized JavaScript and runs successfully as a production build. It connects to the "Deploy to Production" journey phase where developers verify their application is ready for deployment.

## How This Story Contributes

This story validates that the template delivers on its "production-ready" promise by:

- **Validates Build Process**: Confirms TypeScript compilation works correctly, generating clean JavaScript in `dist/` directory
- **Production Execution**: Demonstrates the difference between development (running from TypeScript source) and production (running from compiled JavaScript)
- **Deployment Readiness**: Ensures the built artifact is ready for containerization and deployment platforms
- **Developer Confidence**: Removes the "will it work in production?" fear by making production execution testable locally
- **Enables Deployment Stories**: Story 013.0-DEVELOPER-DEPLOY-EXAMPLE depends on this working build process

## User Story

**Format**: So that I can verify my application is ready for deployment and understand the production build artifacts, as an API Developer, I want to build TypeScript to JavaScript and run the production server locally.

**INVEST Criteria Compliance**:

- **Independent**: Depends only on 002.0 (dependencies installed); can run in parallel with 003.0, 004.0, 007.0
- **Negotiable**: Build optimization settings and output structure can be refined based on deployment needs
- **Valuable**: Delivers confidence that production deployment will work - removes deployment uncertainty
- **Estimable**: Clear scope - build compiles successfully, start command runs the built code, no errors
- **Small**: Single iteration - focused on verifying build and production execution only
- **Testable**: Clear success criteria - build creates dist/ directory, start command runs production server, health endpoint responds

## Acceptance Criteria

- [ ] **Build Succeeds**: Running `npm run build` completes without TypeScript compilation errors
- [ ] **Build Output Generated**: `dist/` directory is created containing compiled JavaScript files with correct directory structure matching `src/`
- [ ] **Type Declarations Generated**: `.d.ts` files are created alongside JavaScript files for TypeScript consumers
- [ ] **Production Start Works**: Running `npm start` successfully starts the server using compiled code from `dist/` directory
- [ ] **Server Responds**: After `npm start`, the server responds to requests (health check endpoint returns 200 OK)
- [ ] **No Source References**: Production server runs entirely from `dist/` - does not require `src/` directory or TypeScript files
- [ ] **Fast Build**: Build completes in reasonable time (< 10 seconds for template code)
- [ ] **Clean Build Output**: Build process has no warnings or errors, output is clean and understandable

## Requirements

- **REQ-BUILD-TSC**: Build uses TypeScript compiler (`tsc`) to compile TypeScript to JavaScript with type checking
- **REQ-BUILD-OUTPUT-DIST**: Compiled JavaScript files are output to `dist/` directory as configured in tsconfig.json
- **REQ-BUILD-DECLARATIONS**: Type declaration files (`.d.ts`) are generated for TypeScript consumers
- **REQ-BUILD-SOURCEMAPS**: Source maps are generated to enable debugging of production code (optional but recommended)
- **REQ-BUILD-CLEAN**: Each build produces clean output - no stale files from previous builds
- **REQ-BUILD-ESM**: Build output uses ES Modules format (matching ADR-0001 TypeScript ESM decision)
- **REQ-START-PRODUCTION**: `npm start` command runs compiled JavaScript from `dist/` directory, not TypeScript source
- **REQ-START-NO-WATCH**: Production start does not include hot reload or file watching (unlike `npm run dev`)
- **REQ-START-PORT**: Production server uses same port configuration as development (environment-based or auto-discovery)
- **REQ-START-LOGS**: Production server outputs structured logs showing server startup and listening address

## Dependencies

- 002.0-DEVELOPER-DEPENDENCIES-INSTALL (TypeScript and dependencies must be installed before build can run)

## Implementation Notes

### Build Process

The `npm run build` command should:

1. Compile TypeScript to JavaScript (e.g., using `tsc` with project configuration)
2. Output compiled files to `dist/` directory
3. Generate type declaration files (`.d.ts`) for TypeScript consumers
4. Perform full type checking and report any type errors
5. Preserve directory structure from `src/` in `dist/` output

### Production Execution

The `npm start` command:

1. Starts the Fastify server using compiled JavaScript from `dist/` directory
2. Uses Node.js to execute the production build (no TypeScript runtime needed)
3. Should work identically to development server but without hot reload
4. Runs with production-ready configuration (can be controlled via NODE_ENV environment variable)

### Key Differences: Development vs Production

| Aspect         | Development (`npm run dev`)          | Production (`npm start`)         |
| -------------- | ------------------------------------ | -------------------------------- |
| Source         | Runs TypeScript directly from `src/` | Runs JavaScript from `dist/`     |
| Hot Reload     | Yes - restarts on file changes       | No - manual restart required     |
| Type Checking  | On file save (incremental)           | At build time (full)             |
| Performance    | Slower (compilation overhead)        | Faster (pre-compiled JavaScript) |
| Error Messages | TypeScript errors in console         | Runtime JavaScript errors        |
| Debugging      | Debug TypeScript directly            | Debug via source maps            |
| Dependencies   | Needs TypeScript compiler            | Needs only Node.js runtime       |

### Understanding Build Artifacts

After `npm run build`, the `dist/` directory contains:

- **JavaScript files** (`.js`): Compiled ESM format code from TypeScript sources
- **Type declarations** (`.d.ts`): TypeScript type information for consumers
- **Directory structure**: Mirrors the `src/` directory structure
- **No TypeScript files**: Production build contains only JavaScript

Example structure (actual files depend on your `src/` organization):

```
dist/
├── *.js           # Compiled JavaScript (ESM format)
└── *.d.ts         # Type declarations
```

### Testing Production Build Locally

Developers should test the production build before deploying:

```bash
# Build the production code
npm run build

# Start the production server
npm start

# In another terminal, test the health endpoint
curl http://localhost:3000/health

# Expected: {"status":"ok"}
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] `npm run build` executes successfully with no errors
- [ ] `dist/` directory contains compiled JavaScript and type declarations
- [ ] `npm start` runs the production server from `dist/` directory
- [ ] Server responds to health check requests after production start
- [ ] Build process is documented in README or development docs
- [ ] Developer understands difference between dev and production execution
- [ ] Build time is acceptable (< 10 seconds)
- [ ] No TypeScript compilation errors or warnings
